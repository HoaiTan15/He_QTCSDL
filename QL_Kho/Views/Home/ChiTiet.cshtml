@model QL_Kho.Models.SANPHAM

@{
    ViewBag.Title = Model.TenSP;
}

<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
        <li class="breadcrumb-item">
            <a href="@Url.Action("DanhMuc", "Home", new { id = Model.MaDM.Trim() })">
                @((ViewBag.DanhMuc != null) ? ViewBag.DanhMuc.TenDM : "")
            </a>
        </li>
        <li class="breadcrumb-item active">@Model.TenSP</li>
    </ol>
</nav>

<div class="row product-detail">
    <!-- Product Images -->
    <div class="col-md-5 mb-4">
        <div class="product-image-container">
            @if (!string.IsNullOrEmpty(Model.HinhAnh))
            {
                <img src="~/Content/images/@Model.HinhAnh"
                     class="img-fluid rounded shadow"
                     alt="@Model.TenSP"
                     id="mainImage"
                     onerror="this.src='https://via.placeholder.com/500x500/667eea/ffffff?text=No+Image'">
            }
            else
            {
                <img src="https://via.placeholder.com/500x500/667eea/ffffff?text=@Model.TenSP"
                     class="img-fluid rounded shadow"
                     alt="@Model.TenSP"
                     id="mainImage">
            }

            <!-- Stock Badge -->
            @if (Model.SoLuongTon <= 0)
            {
                <span class="badge bg-danger position-absolute top-0 start-0 m-3">Hết hàng</span>
            }
            else if (Model.SoLuongTon <= 10)
            {
                <span class="badge bg-warning position-absolute top-0 start-0 m-3">Sắp hết</span>
            }
        </div>
    </div>

    <!-- Product Info -->
    <div class="col-md-7">
        <div class="product-info">
            <h1 class="product-title mb-3">@Model.TenSP</h1>

            <!-- Rating & SKU -->
            <div class="d-flex align-items-center mb-3">
                <div class="product-rating me-4">
                    <i class="fas fa-star text-warning"></i>
                    <i class="fas fa-star text-warning"></i>
                    <i class="fas fa-star text-warning"></i>
                    <i class="fas fa-star text-warning"></i>
                    <i class="fas fa-star text-warning"></i>
                    <span class="text-muted ms-2">(128 đánh giá)</span>
                </div>
                <div class="text-muted">
                    <strong>SKU:</strong> @Model.MaSP
                </div>
            </div>

            <!-- Price -->
            <div class="product-price-section mb-4">
                <div class="current-price">
                    <h2 class="text-danger mb-0">
                        @string.Format("{0:N0}", Model.DonGia) đ
                    </h2>
                </div>
                <div class="old-price text-muted text-decoration-line-through">
                    @string.Format("{0:N0}", Model.DonGia * 1.2m) đ
                </div>
                <span class="badge bg-danger ms-2">-20%</span>
            </div>

            <!-- Stock Status -->
            <div class="stock-info mb-4">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <i class="fas fa-box text-primary me-2"></i>
                            <strong>Tình trạng:</strong>
                            @if (Model.SoLuongTon > 0)
                            {
                                <span class="text-success">Còn hàng (@Model.SoLuongTon sản phẩm)</span>
                            }
                            else
                            {
                                <span class="text-danger">Hết hàng</span>
                            }
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <i class="fas fa-tag text-primary me-2"></i>
                            <strong>Danh mục:</strong>
                            <a href="@Url.Action("DanhMuc", "Home", new { id = Model.MaDM.Trim() })">
                                @((ViewBag.DanhMuc != null) ? ViewBag.DanhMuc.TenDM : "")
                            </a>

                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <div class="info-item">
                            <i class="fas fa-cube text-primary me-2"></i>
                            <strong>Đơn vị:</strong> @Model.DonViTinh
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <i class="fas fa-truck text-primary me-2"></i>
                            <strong>Nhà cung cấp:</strong>
                            @(ViewBag.NhaCungCap != null ? ViewBag.NhaCungCap.TenNCC : "")

                        </div>
                    </div>
                </div>
            </div>

            <!-- Quantity & Add to Cart -->
            @if (Model.SoLuongTon > 0)
            {
                <div class="quantity-cart mb-4">
                    <div class="input-group mb-3" style="max-width: 200px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity()">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="form-control text-center" id="quantity" value="1" min="1" max="@Model.SoLuongTon">
                        <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <div class="d-grid gap-2 d-md-flex">
                        <button class="btn btn-danger btn-lg flex-fill" onclick="addToCart('@Model.MaSP')">
                            <i class="fas fa-cart-plus"></i> Thêm vào giỏ hàng
                        </button>
                        <button class="btn btn-outline-danger btn-lg" onclick="buyNow('@Model.MaSP')">
                            <i class="fas fa-bolt"></i> Mua ngay
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Sản phẩm tạm thời hết hàng. Vui lòng quay lại sau.
                </div>
            }

            <!-- Product Features -->
            <div class="product-features">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="feature-box">
                            <i class="fas fa-shield-alt text-success fa-2x mb-2"></i>
                            <h6>Bảo hành chính hãng</h6>
                            <small>12 tháng</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="feature-box">
                            <i class="fas fa-sync-alt text-primary fa-2x mb-2"></i>
                            <h6>Đổi trả trong 7 ngày</h6>
                            <small>Nếu có lỗi NSX</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="feature-box">
                            <i class="fas fa-shipping-fast text-info fa-2x mb-2"></i>
                            <h6>Giao hàng nhanh</h6>
                            <small>Miễn phí &gt;1 triệu</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="feature-box">
                            <i class="fas fa-headset text-warning fa-2x mb-2"></i>
                            <h6>Hỗ trợ 24/7</h6>
                            <small>Hotline: 0909123456</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Description Tabs -->
<div class="row mt-5">
    <div class="col-12">
        <ul class="nav nav-tabs" id="productTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button">
                    <i class="fas fa-info-circle"></i> Mô tả sản phẩm
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="specs-tab" data-bs-toggle="tab" data-bs-target="#specs" type="button">
                    <i class="fas fa-list"></i> Thông số kỹ thuật
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button">
                    <i class="fas fa-star"></i> Đánh giá (128)
                </button>
            </li>
        </ul>
        <div class="tab-content p-4 border border-top-0 rounded-bottom" id="productTabsContent">
            <div class="tab-pane fade show active" id="description">
                <h4>Mô tả chi tiết</h4>
                @if (!string.IsNullOrEmpty(Model.MoTa))
                {
                    <p>@Html.Raw(Model.MoTa.Replace("\n", "<br>"))</p>
                }
                else
                {
                    <p>Đang cập nhật thông tin sản phẩm...</p>
                }
            </div>
            <div class="tab-pane fade" id="specs">
                <h4>Thông số kỹ thuật</h4>
                <table class="table table-striped">
                    <tbody>
                        <tr>
                            <td><strong>Mã sản phẩm</strong></td>
                            <td>@Model.MaSP</td>
                        </tr>
                        <tr>
                            <td><strong>Tên sản phẩm</strong></td>
                            <td>@Model.TenSP</td>
                        </tr>
                        <tr>
                            <td><strong>Danh mục</strong></td>
                            <td>@((ViewBag.DanhMuc != null) ? ViewBag.DanhMuc.TenDM : "")</td>

                        </tr>
                        <tr>
                            <td><strong>Nhà cung cấp:</strong></td>
                            <td>@(ViewBag.NhaCungCap != null ? ViewBag.NhaCungCap.TenNCC : "")</td>

                        </tr>
                        <tr>
                            <td><strong>Đơn vị tính</strong></td>
                            <td>@Model.DonViTinh</td>
                        </tr>
                        <tr>
                            <td><strong>Bảo hành</strong></td>
                            <td>12 tháng chính hãng</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="reviews">
                <h4>Đánh giá từ khách hàng</h4>
                <div class="review-summary mb-4">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <h1 class="display-3 mb-0">4.8</h1>
                            <div class="text-warning">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                            </div>
                            <p class="text-muted">128 đánh giá</p>
                        </div>
                        <div class="col-md-9">
                            <div class="progress mb-2">
                                <div class="progress-bar bg-warning" style="width: 80%">5★ (102)</div>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-warning" style="width: 15%">4★ (19)</div>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-warning" style="width: 5%">3★ (6)</div>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-warning" style="width: 0%">2★ (1)</div>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-warning" style="width: 0%">1★ (0)</div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="reviews-list">
                    <div class="review-item mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="user-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <strong>N</strong>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0">Nguyễn Văn A</h6>
                                <div class="text-warning mb-1">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                </div>
                                <small class="text-muted">2 ngày trước</small>
                                <p class="mt-2">Sản phẩm rất tốt, đúng như mô tả. Giao hàng nhanh, đóng gói cẩn thận.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Related Products -->
@if (ViewBag.SanPhamLienQuan != null && ((List<QL_Kho.Models.SANPHAM>)ViewBag.SanPhamLienQuan).Any())
{
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4">
                <i class="fas fa-layer-group"></i> Sản phẩm liên quan
            </h3>
        </div>
        @foreach (var item in (List<QL_Kho.Models.SANPHAM>)ViewBag.SanPhamLienQuan)
        {
            <div class="col-6 col-md-3 mb-4">
                <div class="card h-100 product-card-small">
                    <a href="@Url.Action("ChiTiet", "Home", new { id = item.MaSP.Trim() })">
                        @if (!string.IsNullOrEmpty(item.HinhAnh))
                        {
                            <img src="~/Content/images/@item.HinhAnh" class="card-img-top" alt="@item.TenSP"
                                 onerror="this.src='https://via.placeholder.com/200x200/667eea/ffffff?text=No+Image'">
                        }
                        else
                        {
                            <img src="https://via.placeholder.com/200x200/667eea/ffffff?text=@item.TenSP" class="card-img-top" alt="@item.TenSP">
                        }
                    </a>
                    <div class="card-body">
                        <h6 class="card-title">
                            <a href="@Url.Action("ChiTiet", "Home", new { id = item.MaSP.Trim() })" class="text-decoration-none text-dark">
                                @item.TenSP
                            </a>
                        </h6>
                        <p class="card-text text-danger fw-bold">
                            @string.Format("{0:N0} đ", item.DonGia)
                        </p>
                    </div>
                </div>
            </div>
        }
    </div>
}

@section styles {
    <style>
        .product-detail .product-image-container {
            position: relative;
        }

        .product-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .product-rating {
            font-size: 1.1rem;
        }

        .product-price-section {
            background: #f8f9fc;
            padding: 1.5rem;
            border-radius: 10px;
        }

        .current-price h2 {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .old-price {
            font-size: 1.2rem;
        }

        .info-item {
            padding: 0.5rem 0;
        }

        .feature-box {
            text-align: center;
            padding: 1rem;
            background: #f8f9fc;
            border-radius: 10px;
            transition: all 0.3s;
        }

            .feature-box:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

        .product-card-small {
            transition: all 0.3s;
        }

            .product-card-small:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            }

            .product-card-small img {
                height: 200px;
                object-fit: cover;
            }

        .review-item {
            border-bottom: 1px solid #e3e6f0;
            padding-bottom: 1rem;
        }
    </style>
}

@section scripts {
    <script>
        function increaseQuantity() {
            var input = document.getElementById('quantity');
            var max = parseInt(input.max);
            var current = parseInt(input.value);
            if (current < max) {
                input.value = current + 1;
            }
        }

        function decreaseQuantity() {
            var input = document.getElementById('quantity');
            var min = parseInt(input.min);
            var current = parseInt(input.value);
            if (current > min) {
                input.value = current - 1;
            }
        }

        function addToCart(maSP) {
            var quantity = document.getElementById('quantity').value;

            @if (Session["UserID"] == null)
            {
                <text>
                if (confirm('Bạn cần đăng nhập để thêm vào giỏ hàng. Chuyển đến trang đăng nhập?')) {
                    window.location.href = '@Url.Action("Login", "Account")';
                }
                return;
                </text>
            }

            $.ajax({
                url: '@Url.Action("AddToCart", "Cart")',
                type: 'POST',
                data: { maSP: maSP, soLuong: quantity },
                success: function (response) {
                    if (response.success) {
                        $('.badge-notification').text(response.cartCount);
                        alert('Đã thêm vào giỏ hàng!');
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('Có lỗi xảy ra. Vui lòng thử lại!');
                }
            });
        }

        function buyNow(maSP) {
            addToCart(maSP);
            setTimeout(function() {
                window.location.href = '@Url.Action("Index", "Cart")';
            }, 500);
        }
    </script>
}