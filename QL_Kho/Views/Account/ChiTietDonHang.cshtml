@model IEnumerable<QL_Kho.ViewModels.ChiTietDonHangViewModel>

@{
    ViewBag.Title = "Chi tiết đơn hàng";
    var donHang = ViewBag.DonHang as QL_Kho.Models.DONHANG;
}

<!-- Breadcrumb -->
<div class="container-fluid bg-light py-3 mb-4">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")"><i class="fas fa-home"></i> Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("ThongTinCaNhan", "Account")"><i class="fas fa-user"></i> Tài khoản</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("DonHangCuaToi", "Account")"><i class="fas fa-list"></i> Đơn hàng</a></li>
                <li class="breadcrumb-item active"><i class="fas fa-file-invoice"></i> Chi tiết</li>
            </ol>
        </nav>
    </div>
</div>

<div class="container pb-5">
    <!-- Order Header -->
    <div class="order-header card shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h3 class="mb-2">
                        <i class="fas fa-receipt text-primary"></i>
                        Đơn hàng #@donHang.MaDH
                    </h3>
                    <p class="text-muted mb-0">
                        <i class="fas fa-calendar"></i>
                        Đặt ngày: @donHang.NgayDat.ToString("dd/MM/yyyy HH:mm")
                    </p>
                </div>
                <div class="col-md-6 text-end">
                    @{
                        var badgeClass = "secondary";
                        switch (donHang.TrangThai)
                        {
                            case "Chờ xác nhận": badgeClass = "warning"; break;
                            case "Đã xác nhận": badgeClass = "info"; break;
                            case "Đang giao": badgeClass = "primary"; break;
                            case "Đã giao": badgeClass = "success"; break;
                            case "Đã hủy": badgeClass = "danger"; break;
                        }
                    }
                    <h4 class="mb-3">
                        <span class="badge bg-@badgeClass">@donHang.TrangThai</span>
                    </h4>
                    @if (donHang.TrangThai == "Chờ xác nhận")
                    {
                        <button class="btn btn-danger" onclick="cancelOrder('@donHang.MaDH')">
                            <i class="fas fa-times"></i> Hủy đơn hàng
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Order Details -->
        <div class="col-lg-8">
            <!-- Timeline -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-route"></i> Trạng thái đơn hàng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="order-timeline-horizontal">
                        <div class="timeline-step @(donHang.TrangThai != "Đã hủy" ? "completed" : "")">
                            <div class="timeline-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="timeline-content">
                                <h6>Đặt hàng</h6>
                                <small>@donHang.NgayDat.ToString("dd/MM HH:mm")</small>
                            </div>
                        </div>

                        <div class="timeline-line @(new[] { "Đã xác nhận", "Đang giao", "Đã giao" }.Contains(donHang.TrangThai) ? "completed" : "")"></div>

                        <div class="timeline-step @(new[] { "Đã xác nhận", "Đang giao", "Đã giao" }.Contains(donHang.TrangThai) ? "completed" : "") @(donHang.TrangThai == "Chờ xác nhận" ? "active" : "")">
                            <div class="timeline-icon">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="timeline-content">
                                <h6>Xác nhận</h6>
                                <small>@(donHang.TrangThai == "Chờ xác nhận" ? "Đang chờ..." : "Đã xác nhận")</small>
                            </div>
                        </div>

                        <div class="timeline-line @(new[] { "Đang giao", "Đã giao" }.Contains(donHang.TrangThai) ? "completed" : "")"></div>

                        <div class="timeline-step @(new[] { "Đang giao", "Đã giao" }.Contains(donHang.TrangThai) ? "completed" : "") @(donHang.TrangThai == "Đã xác nhận" ? "active" : "")">
                            <div class="timeline-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="timeline-content">
                                <h6>Đang giao</h6>
                                <small>@(donHang.TrangThai == "Đang giao" ? "Đang vận chuyển" : "Chờ giao")</small>
                            </div>
                        </div>

                        <div class="timeline-line @(donHang.TrangThai == "Đã giao" ? "completed" : "")"></div>

                        <div class="timeline-step @(donHang.TrangThai == "Đã giao" ? "completed" : "") @(donHang.TrangThai == "Đang giao" ? "active" : "")">
                            <div class="timeline-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="timeline-content">
                                <h6>Hoàn tất</h6>
                                <small>@(donHang.TrangThai == "Đã giao" ? "Đã giao hàng" : "Chờ hoàn tất")</small>
                            </div>
                        </div>
                    </div>

                    @if (donHang.TrangThai == "Đã hủy")
                    {
                        <div class="alert alert-danger mt-4">
                            <i class="fas fa-times-circle"></i>
                            <strong>Đơn hàng đã bị hủy</strong>
                            <p class="mb-0">Đơn hàng này đã được hủy vào @donHang.NgayCapNhat?.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Products List -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-box"></i> Sản phẩm đã đặt (@Model.Count())
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="100">Hình ảnh</th>
                                    <th>Sản phẩm</th>
                                    <th width="150" class="text-center">Đơn giá</th>
                                    <th width="100" class="text-center">Số lượng</th>
                                    <th width="150" class="text-end">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>
                                            <div class="product-image-small">
                                                @if (!string.IsNullOrEmpty(item.HinhAnh))
                                                {
                                                    if (item.HinhAnh.StartsWith("http"))
                                                    {
                                                        <img src="@item.HinhAnh" alt="@item.TenSP">
                                                    }
                                                    else
                                                    {
                                                        <img src="~/Content/images/@item.HinhAnh" alt="@item.TenSP" onerror="this.src='https://via.placeholder.com/80'">
                                                    }
                                                }
                                                else
                                                {
                                                    <img src="https://via.placeholder.com/80" alt="No image">
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <h6 class="mb-1">@item.TenSP</h6>
                                            <small class="text-muted">Mã: @item.MaSP</small>
                                        </td>
                                        <td class="text-center">
                                            <strong class="text-danger">@string.Format("{0:N0}đ", item.DonGia)</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary">x @item.SoLuong</span>
                                        </td>
                                        <td class="text-end">
                                            <strong class="text-primary">@string.Format("{0:N0}đ", item.ThanhTien)</strong>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <!-- Customer Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user"></i> Thông tin khách hàng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <i class="fas fa-user text-primary"></i>
                        <div>
                            <small class="text-muted d-block">Họ tên</small>
                            <strong>@Session["UserName"]</strong>
                        </div>
                    </div>
                    <div class="info-row">
                        <i class="fas fa-phone text-success"></i>
                        <div>
                            <small class="text-muted d-block">Số điện thoại</small>
                            <strong>@donHang.SDT</strong>
                        </div>
                    </div>
                    <div class="info-row">
                        <i class="fas fa-map-marker-alt text-danger"></i>
                        <div>
                            <small class="text-muted d-block">Địa chỉ giao hàng</small>
                            <strong>@donHang.DiaChiGiao</strong>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(donHang.GhiChu))
                    {
                        <div class="info-row">
                            <i class="fas fa-sticky-note text-warning"></i>
                            <div>
                                <small class="text-muted d-block">Ghi chú</small>
                                <strong>@donHang.GhiChu</strong>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Payment Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-wallet"></i> Thanh toán
                    </h6>
                </div>
                <div class="card-body">
                    <div class="payment-info">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Phương thức:</span>
                            <strong>@donHang.PhuongThucTT</strong>
                        </div>
                        @if (donHang.PhuongThucTT == "COD")
                        {
                            <div class="alert alert-info small mb-0">
                                <i class="fas fa-info-circle"></i>
                                Thanh toán khi nhận hàng
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Order Total -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-receipt"></i> Tổng đơn hàng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="summary-row">
                        <span>Tạm tính:</span>
                        <strong>@string.Format("{0:N0}đ", donHang.TongTien)</strong>
                    </div>
                    <div class="summary-row">
                        <span>Phí vận chuyển:</span>
                        <strong class="text-success">Miễn phí</strong>
                    </div>
                    <div class="summary-row">
                        <span>Giảm giá:</span>
                        <strong>0đ</strong>
                    </div>
                    <hr class="my-3">
                    <div class="summary-total">
                        <h5 class="mb-0">Tổng cộng:</h5>
                        <h4 class="text-danger mb-0">@string.Format("{0:N0}đ", donHang.TongTien)</h4>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="d-grid gap-2 mt-4">
                <a href="@Url.Action("DonHangCuaToi", "Account")" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Quay lại danh sách
                </a>
                @if (donHang.TrangThai == "Đã giao")
                {
                    <button class="btn btn-success" onclick="reviewOrder()">
                        <i class="fas fa-star"></i> Đánh giá đơn hàng
                    </button>
                }
            </div>
        </div>
    </div>

    <!-- Support Section -->
    <div class="card shadow-sm mt-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-1 text-center">
                    <i class="fas fa-headset fa-3x text-primary"></i>
                </div>
                <div class="col-md-8">
                    <h5 class="mb-1">Cần hỗ trợ về đơn hàng này?</h5>
                    <p class="text-muted mb-0">
                        Liên hệ với chúng tôi qua hotline: <strong class="text-primary">1900 xxxx</strong>
                        hoặc email: <strong class="text-primary">support@shopdt.com</strong>
                    </p>
                </div>
                <div class="col-md-3 text-end">
                    <a href="@Url.Action("LienHe", "Home")" class="btn btn-primary">
                        <i class="fas fa-phone"></i> Liên hệ ngay
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section styles {
    <style>
        /* Order Header */
        .order-header {
            border-left: 5px solid #667eea;
        }

        .bg-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Horizontal Timeline */
        .order-timeline-horizontal {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 2rem 1rem;
            position: relative;
        }

        .timeline-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .timeline-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e3e6f0;
            border: 4px solid #e3e6f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #858796;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .timeline-step.completed .timeline-icon,
        .timeline-step.active .timeline-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 0.5rem 1rem rgba(102, 126, 234, 0.3);
        }

        .timeline-step.active .timeline-icon {
            animation: pulse 2s infinite;
        }



        .timeline-content {
            text-align: center;
        }

            .timeline-content h6 {
                font-size: 0.9rem;
                font-weight: 600;
                margin-bottom: 0.25rem;
                color: #2c3e50;
            }

            .timeline-content small {
                font-size: 0.75rem;
                color: #858796;
            }

        .timeline-line {
            position: absolute;
            top: 30px;
            height: 4px;
            background: #e3e6f0;
            z-index: 1;
        }

        .timeline-step:nth-child(1) ~ .timeline-line:nth-of-type(1) {
            left: calc(10% + 30px);
            width: calc(20% - 60px);
        }

        .timeline-step:nth-child(3) ~ .timeline-line:nth-of-type(2) {
            left: calc(30% + 30px);
            width: calc(20% - 60px);
        }

        .timeline-step:nth-child(5) ~ .timeline-line:nth-of-type(3) {
            left: calc(50% + 30px);
            width: calc(20% - 60px);
        }

        .timeline-step:nth-child(7) ~ .timeline-line:nth-of-type(4) {
            left: calc(70% + 30px);
            width: calc(20% - 60px);
        }

        .timeline-line.completed {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        /* Product Image */
        .product-image-small {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
        }

            .product-image-small img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        /* Info Rows */
        .info-row {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px dashed #e3e6f0;
        }

            .info-row:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }

            .info-row i {
                font-size: 1.5rem;
                width: 30px;
                flex-shrink: 0;
            }

        /* Summary */
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px dashed #e3e6f0;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fc 0%, #e3e6f0 100%);
            padding: 1rem;
            border-radius: 8px;
        }
    </style>
}

@section scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function cancelOrder(maDH) {
            Swal.fire({
                title: 'Hủy đơn hàng?',
                text: "Bạn có chắc muốn hủy đơn hàng này? Hành động này không thể hoàn tác.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e74a3b',
                cancelButtonColor: '#858796',
                confirmButtonText: '<i class="fas fa-times"></i> Hủy đơn hàng',
                cancelButtonText: 'Đóng',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return $.ajax({
                        url: '@Url.Action("HuyDonHang", "Account")',
                        type: 'POST',
                        data: { maDH: maDH }
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    if (result.value.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Đã hủy!',
                            text: result.value.message,
                            confirmButtonText: 'OK'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi!',
                            text: result.value.message
                        });
                    }
                }
            });
        }

        function reviewOrder() {
            Swal.fire({
                title: 'Đánh giá đơn hàng',
                html: `
                    <div class="rating-stars mb-3">
                        <i class="fas fa-star star" data-rating="1"></i>
                        <i class="fas fa-star star" data-rating="2"></i>
                        <i class="fas fa-star star" data-rating="3"></i>
                        <i class="fas fa-star star" data-rating="4"></i>
                        <i class="fas fa-star star" data-rating="5"></i>
                    </div>
                    <textarea id="review-text" class="form-control" placeholder="Nhận xét của bạn..." rows="4"></textarea>
                `,
                showCancelButton: true,
                confirmButtonText: 'Gửi đánh giá',
                cancelButtonText: 'Hủy',
                didOpen: () => {
                    const stars = document.querySelectorAll('.star');
                    let rating = 0;

                    stars.forEach(star => {
                        star.addEventListener('click', function() {
                            rating = this.dataset.rating;
                            stars.forEach((s, i) => {
                                s.style.color = i < rating ? '#ffc107' : '#e3e6f0';
                            });
                        });
                    });
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire('Cảm ơn!', 'Đánh giá của bạn đã được gửi.', 'success');
                }
            });
        }
    </script>
}